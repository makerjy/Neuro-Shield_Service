name: ${SERVICE_NAME:-neuro-shield}

services:
  web:
    build:
      context: .
      dockerfile: deploy/web/Dockerfile
      args:
        BASE_PATH: ${BASE_PATH:-/neuro-shield/}
        VITE_STAGE1_DEMO_LINK: ${VITE_STAGE1_DEMO_LINK:-}
        VITE_CITIZEN_DEMO_TOKEN: ${VITE_CITIZEN_DEMO_TOKEN:-R-2ldKkoGbDF-marBFEbgVilAXB5Tw0r}
        VITE_CITIZEN_ENTRY_URL: ${VITE_CITIZEN_ENTRY_URL:-}
    container_name: ${SERVICE_NAME:-neuro-shield}-web
    depends_on:
      api:
        condition: service_healthy
    environment:
      BASE_PATH: ${BASE_PATH:-/neuro-shield/}
    ports:
      - "${WEB_HOST_PORT:-8000}:80"
    restart: unless-stopped

  sms:
    build:
      context: .
      dockerfile: deploy/sms/Dockerfile
    container_name: ${SERVICE_NAME:-neuro-shield}-sms
    environment:
      PORT: "4120"
      SERVER_SECRET: ${SMS_SERVER_SECRET:-change-me}
      MAIN_APP_BASE_URL: ${MAIN_APP_BASE_URL:-http://localhost:5173/neuro-shield/}
      SOLA_API_BASE: ${SOLA_API_BASE:-https://api.solapi.com}
      SOLA_API_KEY: ${SOLA_API_KEY:-}
      SOLA_API_SECRET_KEY: ${SOLA_API_SECRET_KEY:-}
      SOLA_FROM: ${SOLA_FROM:-}
      TEST_SMS_TO: ${TEST_SMS_TO:-}
      DEV_BYPASS_RATE_LIMIT: ${DEV_BYPASS_RATE_LIMIT:-true}
      DEV_BYPASS_AUTH: ${DEV_BYPASS_AUTH:-true}
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:4120/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: deploy/api/Dockerfile
    container_name: ${SERVICE_NAME:-neuro-shield}-api
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      minio:
        condition: service_started
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-local}
      BASE_PATH: ${BASE_PATH:-/neuro-shield/}
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://dbuser:dbpass@db:5432/neuro}
      BACKEND_ENTRY: ${BACKEND_ENTRY:-server_fastapi.app:app}
      USE_MODEL: ${USE_MODEL:-false}
      MODEL_PATH: ${MODEL_PATH:-./models/model.pkl}
      MODEL_GEN_PATH: ${MODEL_GEN_PATH:-./models/model_gen.pkl}
      MODEL_SCALER_PATH: ${MODEL_SCALER_PATH:-./models/model_scaler.pkl}
      DEMO_MODE: ${DEMO_MODE:-false}
      DEMO_RISK_SCALE: ${DEMO_RISK_SCALE:-1.0}
      DEMO_RISK_MAX: ${DEMO_RISK_MAX:-100}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/2}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-neuro-shield-artifacts}
      JWT_SECRET: ${JWT_SECRET:-change-me}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY:-}
      OTP_TTL_SECONDS: ${OTP_TTL_SECONDS:-300}
      OTP_MAX_ATTEMPTS: ${OTP_MAX_ATTEMPTS:-5}
      INVITE_TOKEN_TTL_HOURS: ${INVITE_TOKEN_TTL_HOURS:-48}
      SMS_PROVIDER_BASE_URL: ${SMS_PROVIDER_BASE_URL:-http://sms:4120}
      INGEST_SHARED_SECRET: ${INGEST_SHARED_SECRET:-change-me}
      KPI_REFRESH_CRON: ${KPI_REFRESH_CRON:-*/5 * * * *}
      REPORT_CRON: ${REPORT_CRON:-0 3 * * *}
    ports:
      - "${API_PORT:-80}:8000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      default:
        aliases:
          - api
          - central-api
    restart: unless-stopped

  worker:
    build:
      context: .
      dockerfile: deploy/api/Dockerfile
    container_name: ${SERVICE_NAME:-neuro-shield}-worker
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      minio:
        condition: service_started
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-local}
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://dbuser:dbpass@db:5432/neuro}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/2}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-neuro-shield-artifacts}
      OTP_TTL_SECONDS: ${OTP_TTL_SECONDS:-300}
      OTP_MAX_ATTEMPTS: ${OTP_MAX_ATTEMPTS:-5}
      INVITE_TOKEN_TTL_HOURS: ${INVITE_TOKEN_TTL_HOURS:-48}
      SMS_PROVIDER_BASE_URL: ${SMS_PROVIDER_BASE_URL:-http://sms:4120}
      INGEST_SHARED_SECRET: ${INGEST_SHARED_SECRET:-change-me}
    command: ["celery", "-A", "server_fastapi.app.tasks.celery_app.celery_app", "worker", "--loglevel=INFO"]
    restart: unless-stopped

  beat:
    build:
      context: .
      dockerfile: deploy/api/Dockerfile
    container_name: ${SERVICE_NAME:-neuro-shield}-beat
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      minio:
        condition: service_started
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-local}
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://dbuser:dbpass@db:5432/neuro}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/2}
      S3_ENDPOINT: ${S3_ENDPOINT:-http://minio:9000}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-minioadmin}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-neuro-shield-artifacts}
      KPI_REFRESH_CRON: ${KPI_REFRESH_CRON:-*/5 * * * *}
      REPORT_CRON: ${REPORT_CRON:-0 3 * * *}
      OTP_TTL_SECONDS: ${OTP_TTL_SECONDS:-300}
      OTP_MAX_ATTEMPTS: ${OTP_MAX_ATTEMPTS:-5}
      INVITE_TOKEN_TTL_HOURS: ${INVITE_TOKEN_TTL_HOURS:-48}
      SMS_PROVIDER_BASE_URL: ${SMS_PROVIDER_BASE_URL:-http://sms:4120}
      INGEST_SHARED_SECRET: ${INGEST_SHARED_SECRET:-change-me}
    command: ["celery", "-A", "server_fastapi.app.tasks.celery_app.celery_app", "beat", "--loglevel=INFO", "--schedule=/tmp/celerybeat-schedule"]
    restart: unless-stopped

  db:
    image: postgres:16-alpine
    container_name: ${SERVICE_NAME:-neuro-shield}-db
    environment:
      POSTGRES_DB: ${DB_NAME:-neuro}
      POSTGRES_USER: ${DB_USER:-dbuser}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-dbpass}
    ports:
      - "${DB_HOST_PORT:-5433}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./deploy/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-dbuser} -d ${DB_NAME:-neuro}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      default:
        aliases:
          - db
          - postgres
    restart: unless-stopped

  redis:
    image: redis:7.4-alpine
    container_name: ${SERVICE_NAME:-neuro-shield}-redis
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"
    restart: unless-stopped

  minio:
    image: minio/minio:RELEASE.2025-01-20T14-49-07Z
    container_name: ${SERVICE_NAME:-neuro-shield}-minio
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
    command: ["server", "/data", "--console-address", ":9001"]
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    restart: unless-stopped

  clickhouse:
    image: clickhouse/clickhouse-server:25.1
    container_name: ${SERVICE_NAME:-neuro-shield}-clickhouse
    profiles: ["analytics"]
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_TCP_PORT:-9009}:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    restart: unless-stopped

volumes:
  postgres_data:
    name: ${SERVICE_NAME:-neuro-shield}-postgres-data
  minio_data:
    name: ${SERVICE_NAME:-neuro-shield}-minio-data
  clickhouse_data:
    name: ${SERVICE_NAME:-neuro-shield}-clickhouse-data
